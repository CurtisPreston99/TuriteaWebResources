var table=[],header={};function handleFiles(c){table=[];window.FileReader?getAsText(c[0]):error("Sorry","try to use a higher version browser")}function getAsText(c){var a=new FileReader;a.onload=loadHandler;a.onerror=errorHandler;a.readAsText(c)}
function loadHandler(c){table=CSVToArray(c.target.result,",");c={};for(var a=0;a<table[0].length;a++)c[table[0][a]]=a;header=c;c=[];a=!1;for(var b=0;b<table.length;b++)""!==table[b][header.common_name]&&null!==table[b][header.common_name]&&""!==table[b][header.latitude]&&null!==table[b][header.latitude]&&""!==table[b][header.longitude]&&null!==table[b][header.longitude]&&(0!==b&&(isNaN(parseFloat(table[b][header.latitude]))||isNaN(parseFloat(table[b][header.longitude])))?a=!0:c.push(table[b]));a&&
error("Error","Some of the pins has a wrong latitude or longitude<br/>the other pins are shown here");table=c;display(table)}function errorHandler(c){error("Error","Can't read this file")}function enable(c){var a=$("#line"+c.toString());table[c][0]=!table[c][0];table[c][0]?a.text("remove"):a.text("enable")}
function display(c){for(var a=$("#csvHead"),b=0;b<c[0].length;b++)a.append($("<th>{0}</th>".format(0===b?"add":c[0][b])));a=$("#csvBody");for(b=1;b<c.length;b++){for(var d=c[b],e=$("<tr></tr>"),f=0;f<d.length;f++)0===f?c[b][0]?e.append($("<td><button id=\"line{0}\" onclick='enable({0})'>remove</button></td>".format(b))):e.append($('<td><button id="line{0}" onclick="enable({0})">enable</button></td>'.format(b))):e.append($("<td>{0}</td>".format(d[f])));a.append(e)}}
function tabletoPins(){for(var c=[],a={},b=0;b<table[0].length;b++)a[table[0][b]]=b;for(b=1;b<table.length;b++)if(table[b][0]){var d={};d.name=table[b][a.common_name];d.tag_type="zoo";d.lat=parseFloat(table[b][a.latitude])+getNumberInNormalDistribution(0,5E-7);d.lon=parseFloat(table[b][a.longitude])+getNumberInNormalDistribution(0,5E-7);d.color="#FFFFFF";d.description=pinGenerateDiscription(table[b]);d.time=2;c.push(d)}a={};a.data=JSON.stringify(c);$.post("../api/addPins?num="+c.length.toString(16),
a,function(a){message("Thank you","upload success")}).fail(function(){error("Error","Please login and retry.")})}
function pinGenerateDiscription(c){var a=$("<p></p>");a.append($('<p><a href="{0}" target="_blank">look at me on inaturalist.nz</a></p>'.format(c[header.url])));""!==c[header.image_url]&&a.append($('<img src="{0}" alt="{0}"/>'.format(c[header.image_url])));a.append($("<p>{0}</p>".format(c[header.description])));for(var b=$("<table></table>"),d=table[0],e=0;e<d.length;e++){var f=d[e],g=c[header[f]];g&&"latitude"!==g&&"longitude"!==g&&b.append("'<tr><td>{0}</td><td>{1}</td></tr>".format(f,g))}a.append(b);
return a.html()}function CSVToArray(c,a){a=a||",";for(var b=new RegExp("(\\"+a+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+a+"\\r\\n]*))","gi"),d=[[]],e;e=b.exec(c);){var f=e[1];f.length&&f!==a&&d.push([]);e=e[2]?e[2].replace(RegExp('""',"g"),'"'):e[3];d[d.length-1].push(e)}return d}function getNumberInNormalDistribution(c,a){return c+randomNormalDistribution()*a}
function randomNormalDistribution(){do{var c=2*Math.random()-1;var a=2*Math.random()-1;a=c*c+a*a}while(0===a||1<=a);return c*Math.sqrt(-2*Math.log(a)/a)};